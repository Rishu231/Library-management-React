{"ast":null,"code":"import axios from \"axios\";\nconst api = axios.create({\n  baseURL: \"http://127.0.0.1:8000\",\n  // Django backend URL\n  withCredentials: true,\n  headers: {\n    \"Content-Type\": \"application/json\"\n  }\n});\n\n// Function to fetch CSRF token from Django\nexport const fetchCsrfToken = async () => {\n  try {\n    const response = await api.get(\"/api/csrf/\"); // Django CSRF endpoint\n    return response.data.csrfToken;\n  } catch (error) {\n    console.error(\"Failed to fetch CSRF token:\", error);\n    return null;\n  }\n};\n\n// Function to get CSRF token from cookies\nexport const getCsrfToken = () => {\n  const cookies = document.cookie.split(\"; \");\n  const csrfCookie = cookies.find(row => row.startsWith(\"csrftoken=\"));\n  return csrfCookie ? csrfCookie.split(\"=\")[1] : null;\n};\n\n// Fetch CSRF token when app starts\nfetchCsrfToken().then(token => {\n  if (token) {\n    document.cookie = `csrftoken=${token}; path=/;`;\n  }\n});\n\n// Automatically attach JWT token and CSRF token to requests\napi.interceptors.request.use(config => {\n  const token = localStorage.getItem(\"access_token\");\n  const csrfToken = getCsrfToken();\n  if (token) {\n    config.headers.Authorization = `Bearer ${token}`;\n  }\n  if (csrfToken) {\n    config.headers[\"X-CSRFToken\"] = csrfToken;\n  }\n  return config;\n});\n\n// Handle token expiration: Refresh and retry failed requests\napi.interceptors.response.use(response => response, async error => {\n  var _error$response;\n  const originalRequest = error.config;\n  if (((_error$response = error.response) === null || _error$response === void 0 ? void 0 : _error$response.status) === 401 && !originalRequest._retry) {\n    originalRequest._retry = true;\n    const refreshToken = localStorage.getItem(\"refresh_token\");\n    if (!refreshToken) {\n      console.error(\"No refresh token found. Logging out...\");\n      logoutUser();\n      return Promise.reject(error);\n    }\n    try {\n      const res = await axios.post(\"http://127.0.0.1:8000/api/token/refresh/\", {\n        refresh: refreshToken\n      });\n      localStorage.setItem(\"access_token\", res.data.access);\n      api.defaults.headers.common[\"Authorization\"] = `Bearer ${res.data.access}`;\n      return api(originalRequest);\n    } catch (refreshError) {\n      console.error(\"Session expired. Logging out...\");\n      logoutUser();\n      return Promise.reject(refreshError);\n    }\n  }\n  return Promise.reject(error);\n});\nconst logoutUser = () => {\n  localStorage.removeItem(\"access_token\");\n  localStorage.removeItem(\"refresh_token\");\n  window.location.href = \"/\"; // Redirect to login page\n};\nexport default api;","map":{"version":3,"names":["axios","api","create","baseURL","withCredentials","headers","fetchCsrfToken","response","get","data","csrfToken","error","console","getCsrfToken","cookies","document","cookie","split","csrfCookie","find","row","startsWith","then","token","interceptors","request","use","config","localStorage","getItem","Authorization","_error$response","originalRequest","status","_retry","refreshToken","logoutUser","Promise","reject","res","post","refresh","setItem","access","defaults","common","refreshError","removeItem","window","location","href"],"sources":["/Users/raj/Web application/book_management/src/services/api.js"],"sourcesContent":["import axios from \"axios\";\n\nconst api = axios.create({\n  baseURL: \"http://127.0.0.1:8000\", // Django backend URL\n  withCredentials: true,\n  headers: {\n    \"Content-Type\": \"application/json\",\n  },\n});\n\n// Function to fetch CSRF token from Django\nexport const fetchCsrfToken = async () => {\n  try {\n    const response = await api.get(\"/api/csrf/\"); // Django CSRF endpoint\n    return response.data.csrfToken;\n  } catch (error) {\n    console.error(\"Failed to fetch CSRF token:\", error);\n    return null;\n  }\n};\n\n// Function to get CSRF token from cookies\nexport const getCsrfToken = () => {\n  const cookies = document.cookie.split(\"; \");\n  const csrfCookie = cookies.find((row) => row.startsWith(\"csrftoken=\"));\n  return csrfCookie ? csrfCookie.split(\"=\")[1] : null;\n};\n\n// Fetch CSRF token when app starts\nfetchCsrfToken().then((token) => {\n  if (token) {\n    document.cookie = `csrftoken=${token}; path=/;`;\n  }\n});\n\n// Automatically attach JWT token and CSRF token to requests\napi.interceptors.request.use((config) => {\n  const token = localStorage.getItem(\"access_token\");\n  const csrfToken = getCsrfToken();\n\n  if (token) {\n    config.headers.Authorization = `Bearer ${token}`;\n  }\n  if (csrfToken) {\n    config.headers[\"X-CSRFToken\"] = csrfToken;\n  }\n\n  return config;\n});\n\n// Handle token expiration: Refresh and retry failed requests\napi.interceptors.response.use(\n  (response) => response,\n  async (error) => {\n    const originalRequest = error.config;\n\n    if (error.response?.status === 401 && !originalRequest._retry) {\n      originalRequest._retry = true;\n      const refreshToken = localStorage.getItem(\"refresh_token\");\n\n      if (!refreshToken) {\n        console.error(\"No refresh token found. Logging out...\");\n        logoutUser();\n        return Promise.reject(error);\n      }\n\n      try {\n        const res = await axios.post(\"http://127.0.0.1:8000/api/token/refresh/\", {\n          refresh: refreshToken,\n        });\n\n        localStorage.setItem(\"access_token\", res.data.access);\n        api.defaults.headers.common[\"Authorization\"] = `Bearer ${res.data.access}`;\n\n        return api(originalRequest);\n      } catch (refreshError) {\n        console.error(\"Session expired. Logging out...\");\n        logoutUser();\n        return Promise.reject(refreshError);\n      }\n    }\n\n    return Promise.reject(error);\n  }\n);\n\nconst logoutUser = () => {\n  localStorage.removeItem(\"access_token\");\n  localStorage.removeItem(\"refresh_token\");\n  window.location.href = \"/\"; // Redirect to login page\n};\n\nexport default api;\n"],"mappings":"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","ignoreList":[]},"metadata":{},"sourceType":"module","externalDependencies":[]}